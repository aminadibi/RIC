---
title: "Relative Impact Characteristic (RIC) Curve"
author: "Mohsen Sadatsafavi, Amin Adibi"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Relative Impact Characteristic (RIC) Curve}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```
Relative Impact Characteristic (RIC) curve is a novel graphical tool that visualizes 
the trade-off between the population-level impact of a treatment as a function of the size of the treated population for a given marker threshold. While the Receiver Operating Characteristic (ROC) curve and its associated metrics quanitfy the diagnostic performance of a biomarker at the patient-level, RIC curve provides insights into a marker's ability towards concentrating treatment benefit at the population level.

Interpretations of shape, area under curve and slope in RIC curve are analogous to the widely used ROC curve, making it easier to use by the research community. The following sections outline basic characteristics of the RIC curve and provide an example that illustrates its use. For a more comphrenesive discussion and a case study, please refer to the original research paper entitled *Relative Impact Characteristic (RIC) curve: a graphical tool to visualize and quantify the clinical utility and population-level consequences of implementing markers* ^[Mohsen Sadatsafavi, Paul Gustafson, Zafar Zafari, and Don D. Sin, **Relative Impact Characteristic (RIC) curve: a graphical tool to visualize and quantify the clinical utility and population-level consequences of implementing markers**, *Annals of Epidemiology*]  

## Defintion of the RIC Curve

In its most basic use case, the RIC curve can be drawn for a single disease biomarker or a risk prediction score. The marker is assumed to have a continuous value, and to be used for a binary treatment decision. We assume that patients with marker values higher than a threshold value $x$ are to recieve the treatment.  

The horizontal axis of the plot, $p$, is defined as the proportion of the population that receives the treatment. Note that $p$ is a function of the marker threshold value $x$:  

$p(x) = \int_x^{+\infty} f(y) dy$

where $f$ is the probability distribution of the marker value in the population.

$\bar{b} = \int _x ^{+\infty} b(y)f(y)dy$

$q(x) = \int _x ^{+\infty} b(y)f(y)dy/ \bar{b}$

The RIC curve is a plot of $p(x)$ against $q(x)$ as $x$ varies. 


## Shape of the RIC curve


## Area Under the Curve

## Slopes of the RIC curve


## Example with Simulated Data

You can write math expressions, e.g. $Y = X\beta + \epsilon$, and tables, e.g. using 
```{r, echo=FALSE}
library(RIC)
tab <- head(reg_data)
knitr::kable(tab)
```

```{r, echo=TRUE, results='asis'}
#knitr::kable(head(mtcars, 10))
library(RIC)
#Is called by the main code (below) to calculate RIC metrics using different methods
ric=function(marker_formula=events~tx+c1+c2+c3+offset(ln_time),q_formula=events~tx+c1+c2+c3+offset(ln_time),sample_size=1000)
{
  message("legend:\n dark line: empirical RIC\n grey line: parameteric approximation of RIC\n emp: empirical \n mfc: method of forced choice: simulating pairs of subjects and a=giving treatment to the one with higher marker value, b=giving both treatment, c) calculating the average benefit of a over b.\n parm: parametric approximation)")
  pred_data<-reg_data
  pred_data[,'ln_time']<-0
  #G-computation
  reg_object<-MASS::glm.nb(data=reg_data,formula=q_formula,link=log)
  res<-ric_regression(reg_object,pred_data)
  plot(res$pq[,1],res$pq[,2],type='l',xlab="Proportion treated",ylab="Relative benefit",xlim=c(0,1),ylim=c(0,1))
  text(0.7,0.3,paste("AUCi (emp):",round(res$auci,3)))
  #Parametric RIC (Appendix II) based on estimated mean and covariance matrix of (x,b).
  xb_data<-res$xb_data
  xb_data[,2]<-log(xb_data[,2])
  temp<-ric_parametric(p_x=(0:100)/100,mu_x =mean(xb_data[,1]),sd_x = sd(xb_data[,1]), mu_b = mean(xb_data[,2]), sd_b = sd(xb_data[,2]),rho = cor(xb_data)[1,2],type = "lognormal")
  lines(temp$p_x,temp$q_x,lty=6,col='grey')
  text(0.7,0.2,paste("AUCi (parm):",round(temp$auci,3)))
  #Simulating the method of forced choice: creating pairs of subjects and a=giving treatment to the one with higher marker value, b=giving both treatment, c) calculating the average benefit of a over b
  #see auci_mfc() for details
  text(0.7,0.1,paste("AUCi (mfc):",round(auci_mfc(res$xb),3)))
}

#Main code

#Complete score (includes all covariates)
ric(marker_formula=events~tx+c1+c2+c3+offset(ln_time))
title("Figure 1")

#Partial score with C2 removed - note that RIC becomes jagged
ric(marker_formula=events~tx+c1+c3+offset(ln_time))
title("Figure 2")


#Non-informative marker (c1 is not associated with the outcome) - note that RIC becomes jagged
ric(marker_formula=events~tx+c1+offset(ln_time))
title("Figure 3")

```
